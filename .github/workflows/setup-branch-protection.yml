name: Setup Branch Protection

on:
  workflow_dispatch: # Manual trigger to apply branch protection rules

permissions:
  administration: write

jobs:
  protect-main:
    runs-on: ubuntu-latest

    steps:
      - name: Apply branch protection to main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method PUT \
            "repos/${{ github.repository }}/branches/main/protection" \
            --input - <<'EOF'
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["test"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false
          }
          EOF
          echo "Branch protection applied to main"
