name: Setup Branch Protection

# Manual trigger to apply branch protection rules.
# Requires a fine-grained PAT stored as the ADMIN_TOKEN secret.
# Create one at: https://github.com/settings/personal-access-tokens/new
#   - Resource owner: your account
#   - Repository access: "Only select repositories" → MiBiblioteca
#   - Permissions → Repository → Administration: Read and write
on:
  workflow_dispatch:

jobs:
  protect-main:
    runs-on: ubuntu-latest

    steps:
      - name: Apply branch protection to main
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          gh api --method PUT \
            "repos/${{ github.repository }}/branches/main/protection" \
            --input - <<'EOF'
          {
            "required_status_checks": {
              "strict": true,
              "contexts": ["test"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false
          }
          EOF
          echo "Branch protection applied to main"
